#!/usr/bin/env raku
use v6.d;

use Graphviz::DOT::Grammar;

my %*SUB-MAIN-OPTS = :named-anywhere;

#-----------------------------------------------------------

#| Converts Markdown files into Jupyter and Mathematica notebooks, and HTML, Org-mode, and Pod6 files.
sub MAIN(Str $text,                                  #= Input file or Markdown text.
         Str :t(:$to) = 'Whatever',                  #= Format to convert to. (One of 'mermaid', 'mathematica', 'svg', or 'Whatever'.)
         Str :o(:$output) = '',                      #= Output file; if an empty string then the result is printed to stdout.
         ) {



    my $toSpec = $to;
    if !$to || $to.lc âˆˆ <whatever automatic> {
        $toSpec = do given $output {
            when !$_.chars { 'mathematica' }
            when $_ ~~ / '.wl' | '.m' / { 'mathematica' }
            when $_ ~~ / '.dot' / { 'dot' }
            when $_ ~~ / '.svg' / { 'svg' }
            when $_ ~~ / '.eps' / { '.eps' }
            when $_ ~~ / '.md' | '.mermaid' / { 'mermaid' }
            when $_ ~~ / '.raku' | '.p6' / { 'raku' }
            default {
                note 'Cannot automatically determine the format to convert to.';
                'mathematica'
            }
        }
    }

    my $res = dot-interpret($text, actions => $to);

    if $output.chars > 0 {
        spurt($output, $res);
    } else {
        say $res;
    }
}